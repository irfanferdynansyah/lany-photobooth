<!DOCTYPE html>
<html>
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B736VK5Y83"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-B736VK5Y83');
    </script>
    <title>LANY XXL Photobooth</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #06081a; color: #5080cc; font-family: 'DM Sans', sans-serif; text-align: center; min-height: 100vh; }

        .screen { display: none; min-height: 100vh; padding: 40px 20px; flex-direction: column; align-items: center; justify-content: center; }
        .screen.active { display: flex; }
        #screen-template, #screen-camera, #screen-result { background: #06081a; }

        .screen-label { font-size: 11px; letter-spacing: 5px; text-transform: uppercase; color: #3060aa; margin-bottom: 16px; }
        .screen-title { font-family: 'Playfair Display', serif; font-size: clamp(40px, 8vw, 80px); font-weight: 700; color: white; text-shadow: 0 0 40px #4080ff88; margin-bottom: 8px; letter-spacing: -2px; }
        .screen-sub { font-style: italic; color: #5080cc; margin-bottom: 48px; font-size: 16px; }

        .template-grid { display: flex; gap: 24px; justify-content: center; flex-wrap: wrap; margin-bottom: 40px; }
        .template-card { width: 200px; cursor: pointer; border: 2px solid #1a2555; border-radius: 16px; overflow: hidden; transition: all 0.3s; background: #0a0d25; }
        .template-card:hover { transform: translateY(-6px); border-color: #4080ff; box-shadow: 0 20px 50px #4080ff33; }
        .template-card.selected { border-color: #4080ff; box-shadow: 0 0 0 3px #4080ff44; }
        .template-card img { width: 100%; height: 260px; object-fit: cover; object-position: top; display: block; }
        .template-card-label { padding: 12px; font-size: 13px; font-weight: 500; letter-spacing: 2px; text-transform: uppercase; color: #7aaaf5; }
        .template-card.selected .template-card-label { color: white; }

        .btn-primary { background: #4080ff; color: white; border: none; padding: 16px 50px; font-size: 14px; font-weight: 500; border-radius: 100px; cursor: pointer; letter-spacing: 3px; text-transform: uppercase; transition: all 0.3s; box-shadow: 0 10px 40px #4080ff44; }
        .btn-primary:hover { background: #2060dd; transform: translateY(-2px); box-shadow: 0 16px 50px #4080ff66; }

        .cam-wrap { position: relative; display: inline-block; border-radius: 12px; overflow: hidden; border: 2px solid #1a2555; box-shadow: 0 0 40px #4080ff22; margin: 20px 0; }
        video { width: min(640px, 90vw); display: block; transform: scaleX(-1); }

        #countdown-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; font-family: 'Playfair Display', serif; font-size: 120px; font-weight: 700; color: white; text-shadow: 0 0 40px #4080ff; }

        .counter { font-size: 18px; font-weight: 500; margin: 8px 0; color: #4080ff; letter-spacing: 3px; }

        .thumbs { display: flex; gap: 10px; justify-content: center; margin: 12px 0; flex-wrap: wrap; }
        .thumb { width: 80px; height: 60px; border-radius: 8px; object-fit: cover; border: 2px solid #1a2555; cursor: pointer; transition: 0.2s; }
        .thumb:hover { border-color: #ff4040; transform: scale(1.05); }
        .thumb-empty { width: 80px; height: 60px; border-radius: 8px; border: 2px dashed #1a2555; background: #0a0d25; }

        .btn-snap { background: #0a1a55; color: #80b0ff; border: 1px solid #4080ff; padding: 15px 40px; font-size: 18px; font-weight: bold; border-radius: 50px; cursor: pointer; margin: 8px; transition: 0.3s; letter-spacing: 2px; }
        .btn-snap:hover { background: #4080ff; color: white; box-shadow: 0 0 20px #4080ff; }

        .btn-generate { display: none; background: #0a3a1a; border: 1px solid #40ff80; color: #80ffaa; padding: 15px 40px; font-size: 18px; font-weight: bold; border-radius: 50px; cursor: pointer; margin: 8px; transition: 0.3s; letter-spacing: 2px; }
        .btn-generate:hover { background: #40ff80; color: #000; }
        .btn-generate:disabled { background: #111; color: #333; border-color: #333; cursor: not-allowed; }

        .result-img { width: min(400px, 85vw); border-radius: 12px; box-shadow: 0 20px 60px #4080ff44; margin: 24px 0; }
        .btn-download { background: #4080ff; color: white; border: none; padding: 16px 50px; font-size: 14px; font-weight: 500; border-radius: 100px; cursor: pointer; letter-spacing: 3px; text-transform: uppercase; transition: all 0.3s; box-shadow: 0 10px 40px #4080ff44; text-decoration: none; display: inline-block; margin: 8px; }
        .btn-download:hover { background: #2060dd; transform: translateY(-2px); }
        .btn-again { background: transparent; border: 1px solid #4080ff; color: #4080ff; padding: 14px 40px; font-size: 14px; border-radius: 100px; cursor: pointer; letter-spacing: 3px; text-transform: uppercase; transition: all 0.3s; margin: 8px; }
        .btn-again:hover { background: #4080ff22; }

        #flash { position: fixed; inset: 0; background: white; opacity: 0; pointer-events: none; z-index: 999; }
        .active-flash { animation: fl 0.25s ease-out; }
        @keyframes fl { 0% { opacity: 1; } 100% { opacity: 0; } }

        #status { margin-top: 16px; font-weight: bold; font-size: 15px; color: #7aaaf5; }
        .spinner { width: 40px; height: 40px; border: 3px solid #1a2555; border-top-color: #4080ff; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 16px auto; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div id="flash"></div>
<canvas id="canvas" style="display:none;" width="640" height="480"></canvas>

<!-- SCREEN 1: PILIH TEMPLATE -->
<div id="screen-template" class="screen active">
    <p class="screen-label">Photophoria Present</p>
    <h1 class="screen-title">LANY â€“ XXL</h1>
    <p class="screen-sub">Pilih template favoritmu</p>

    <div class="template-grid">
        <div class="template-card selected" onclick="selectTemplate('soft', this)">
            <img src="{{ url_for('static', filename='template_soft.png') }}" alt="Soft">
            <div class="template-card-label">âœ¦ Soft</div>
        </div>
        <div class="template-card" onclick="selectTemplate('blue', this)">
            <img src="{{ url_for('static', filename='template_blue.png') }}" alt="Blue">
            <div class="template-card-label">â—‡ Blue</div>
        </div>
        <div class="template-card" onclick="selectTemplate('dark', this)">
            <img src="{{ url_for('static', filename='template_dark.png') }}" alt="Dark">
            <div class="template-card-label">â—ˆ Dark</div>
        </div>
    </div>

    <button class="btn-primary" onclick="goToCamera()">Mulai Foto â†’</button>
</div>

<!-- SCREEN 2: KAMERA -->
<div id="screen-camera" class="screen">
    <p class="screen-label">Photophoria Present</p>
    <h1 class="screen-title" style="font-size:clamp(32px,6vw,60px);">LANY â€“ XXL</h1>

    <div class="cam-wrap">
        <video id="video" autoplay playsinline></video>
        <div id="countdown-overlay"></div>
    </div>

    <div class="thumbs" id="thumbRow">
        <div class="thumb-empty"></div>
        <div class="thumb-empty"></div>
        <div class="thumb-empty"></div>
    </div>

    <div class="counter" id="counterText">Photos: 0 / 3</div>

    <div>
        <button class="btn-snap" id="snapBtn" onclick="startCountdown()">TAKE PHOTO ðŸ“¸</button>
        <button class="btn-generate" id="processBtn" onclick="sendToPython()">GENERATE STRIP âœ¨</button>
    </div>
    <div id="status"></div>
    <div class="spinner" id="spinner"></div>
</div>

<!-- SCREEN 3: RESULT -->
<div id="screen-result" class="screen">
    <p class="screen-label">Your photostrip is ready!</p>
    <h1 class="screen-title" style="font-size:clamp(32px,6vw,60px);">LANY â€“ XXL</h1>
    <p class="screen-sub">i love you so bad // 2026</p>
    <img id="resultImg" class="result-img" src="" alt="result">
    <div>
        <a id="downloadBtn" class="btn-download" href="#" download>Download Strip â†“</a>
        <button class="btn-again" onclick="resetAll()">Foto Lagi â†º</button>
    </div>
</div>

<script>
    let selectedTemplate = 'soft';
    let shots = [];
    let countdownTimer = null;

    function selectTemplate(name, el) {
        selectedTemplate = name;
        document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
    }

    function goToCamera() {
        showScreen('screen-camera');
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(s => document.getElementById('video').srcObject = s)
            .catch(() => alert('Izinkan akses kamera ya!'));
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function startCountdown() {
        if (shots.length >= 3) return;
        document.getElementById('snapBtn').disabled = true;
        const overlay = document.getElementById('countdown-overlay');
        overlay.style.display = 'flex';
        let count = 3;
        overlay.innerText = count;

        countdownTimer = setInterval(() => {
            count--;
            if (count > 0) {
                overlay.innerText = count;
            } else {
                clearInterval(countdownTimer);
                overlay.innerText = 'ðŸ“¸';
                setTimeout(() => {
                    overlay.style.display = 'none';
                    takeSnap();
                    document.getElementById('snapBtn').disabled = false;
                }, 400);
            }
        }, 800);
    }

    function takeSnap() {
        document.getElementById('flash').classList.add('active-flash');
        setTimeout(() => document.getElementById('flash').classList.remove('active-flash'), 250);

        const c = document.getElementById('canvas');
        const ctx = c.getContext('2d');
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.translate(640, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(document.getElementById('video'), 0, 0, 640, 480);
        const dataUrl = c.toDataURL('image/jpeg', 0.92);
        shots.push(dataUrl);

        updateThumbs();
        document.getElementById('counterText').innerText = `Photos: ${shots.length} / 3`;

        if (shots.length === 3) {
            document.getElementById('snapBtn').style.display = 'none';
            document.getElementById('processBtn').style.display = 'inline-block';
        }
    }

    function updateThumbs() {
        const row = document.getElementById('thumbRow');
        row.innerHTML = '';
        for (let i = 0; i < 3; i++) {
            if (shots[i]) {
                const img = document.createElement('img');
                img.src = shots[i];
                img.className = 'thumb';
                img.title = 'Klik untuk hapus & retake';
                img.onclick = () => retakePhoto(i);
                row.appendChild(img);
            } else {
                const div = document.createElement('div');
                div.className = 'thumb-empty';
                row.appendChild(div);
            }
        }
    }

    function retakePhoto(index) {
        shots.splice(index, 1);
        updateThumbs();
        document.getElementById('counterText').innerText = `Photos: ${shots.length} / 3`;
        document.getElementById('snapBtn').style.display = 'inline-block';
        document.getElementById('snapBtn').disabled = false;
        document.getElementById('processBtn').style.display = 'none';
    }

    function sendToPython() {
        document.getElementById('processBtn').disabled = true;
        document.getElementById('status').innerText = "Crafting your strip...";
        document.getElementById('spinner').style.display = 'block';

        fetch('/process', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ images: shots, template: selectedTemplate })
        })
        .then(r => r.json())
        .then(d => {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('resultImg').src = `/download/${d.file}?preview=1`;
            document.getElementById('downloadBtn').href = `/download/${d.file}`;
            document.getElementById('downloadBtn').download = `LANY_XXL_photostrip.jpg`;
            showScreen('screen-result');
        })
        .catch(() => {
            document.getElementById('status').innerText = "Error! Coba lagi.";
            document.getElementById('processBtn').disabled = false;
            document.getElementById('spinner').style.display = 'none';
        });
    }

    function resetAll() {
        shots = [];
        updateThumbs();
        document.getElementById('counterText').innerText = 'Photos: 0 / 3';
        document.getElementById('snapBtn').style.display = 'inline-block';
        document.getElementById('snapBtn').disabled = false;
        document.getElementById('processBtn').style.display = 'none';
        document.getElementById('processBtn').disabled = false;
        document.getElementById('status').innerText = '';
        showScreen('screen-template');
    }
</script>
</body>
</html>